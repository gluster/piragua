language: "shell"
sudo: "true"
os: centos7x
branches:
  only:
    - master
script:
  - P=$(pwd)
  - curl https://sh.rustup.rs -o rustup.sh
  - chmod +x rustup.sh
  - echo "Installing nightly rust"
  - ./rustup.sh --default-toolchain nightly -y
  - echo "Installing deps"
  - sudo yum update -y
  - echo "installing centos-release-gluster"
  - sudo yum install -y centos-release-gluster openssl-devel.x86_64
  - echo "installing gfapi"
  - sudo yum install -y glusterfs-api-devel glusterfs-api gcc rpm-build
  - echo "Building"
  - ~/.cargo/bin/cargo build --release --all
  - TAR_PATH=/gluster-flexvol.0.${GIT_COMMIT}
  - sudo mkdir ${TAR_PATH}
  - cp -R $P/* ${TAR_PATH}
  - cd /
  - sudo tar -czvvpf gluster-flexvol-0.${GIT_COMMIT}.tar.gz ${TAR_PATH}/src ${TAR_PATH}/Cargo.toml ${TAR_PATH}/Cargo.lock $/systemd ${TAR_PATH}/tests ${TAR_PATH}/target/release/gluster-flexvol
  - sudo mkdir -p /root/rpmbuild/SOURCES
  - sudo cp gluster-flexvol-0.${GIT_COMMIT}.tar.gz /root/rpmbuild/SOURCES/
  - cd $P
  - echo "Building rpm"
  - sudo rpmbuild --define "_builddir $(pwd)" -bb gluster-flexvol.spec
  - ls /root/rpmbuild/RPMS/x86_64/
